from pwn import remote
from PIL import Image, ImageDraw
from pyzbar.pyzbar import decode


def make_qr(qr_list, size, n):
    height = len(qr_list) * size
    width = len(qr_list[0]) * size

    assert height == width

    im = Image.new("RGB", (height, width), (255, 255, 255))
    draw = ImageDraw.Draw(im)

    for h, row in enumerate(qr_list):
        for w, col in enumerate(row):
            if col == b"1":
                draw.rectangle((h*size, w*size, (h+1)*size, (w+1)*size), fill=(0,0,0))

    return decode(im)[0].data


if __name__ == '__main__':
    target = "qr-generator.ctf.defenit.kr"
    port = 9000
    
    s = remote(target, port)

    s.recvuntil("? ")
    s.sendline("unchi")


    for i in range(100):
        s.recvuntil("< QR >\n")
        qr_list = []
        while True:
            r = s.recvline().rstrip().split(b" ")
            if b"0" not in r or b"1" not in r:
                break
            qr_list.append(r)

        ans = make_qr(qr_list, 10, i)

        s.recvuntil(">> ")
        s.sendline(ans)

        r = s.recv(4096)
        if b"Correct!" not in r:
            print("???")
        else:
            print("ok:", i)

    s.recvuntil(b"FLAG!\n")

    while True:
        r = s.recvline()
        if b"Defenit" in r:
            print(r)
            break
    s.close()
